os: linux
dist: bionic

language: go

jobs:
  include:
    - go: 1.13.x
      env:
        - ARTIFACT=true
    # - go: 1.12.x
  allow_failures:
    # - go: 1.14.x

env:
  global:
    # Enable Go Module Support
    - GO111MODULE=on

before_install:
  - go get github.com/mitchellh/gox

install:
  - # skip

script:
  - set -e
  - go get -t -v ./...
  - diff -u <(echo -n) <(gofmt -d .)
  - go vet $(go list ./... | grep -v /vendor/)
  - go test -v -race ./...
  - | # Only build binaries from the supported Go version
      if [ "${ARTIFACT}" = "true" ]; then
        CGO_ENABLED=0
        GOFLAGS=-mod=vendor
        gox -os="darwin linux windows" \
            -arch="amd64" \
            -output="release/aws-get-secret_{{.OS}}_{{.Arch}}" \
            -ldflags "-X main.GitCommit=$TRAVIS_COMMIT -X main.ReleaseVer=$TRAVIS_TAG" \
            -verbose ./...;
        find release/* -type f -exec sh -c 'sha256sum {} | cut -f1 -d" " > {}.SHA256SUM' \;
        find release/* -not -name "*.SHA256SUM" -type f -print0 | xargs -0 -n 1 -I '{@}' zip -jm {@}.zip {@}
        find release/* -type f -not -name "*.SHA256SUM" -exec sh -c 'sha256sum {} | cut -f1 -d" " > {}.SHA256SUM' \;
      fi

deploy:
  provider: releases
  api_key:
    secure: hi4LDd0B96Q/wAOsmCjDSF01Q/u9svPJnbYImksp+tHisD1KxXC2QMGZS/jimZFKkqiKoEGTTMYKxUEFfXfHkGlBI9IXSPF4K+f1wX9/6XRHzJQY4B9BOYUCRTnPr3nlLJrqG0C3ReseH3GEgkHs6neCm++HzP7yYGX8GcIjZh6GwzmOn/XGherCIpXByhga7w0QN3IQCnuAUKv1jNEeqfSDzEzACkRwDj8pr2RT15ScJIQ4eEd9wuhRhNzbP2+l+bwIHnbBg/YAVaAiOTQ4KcEcizSYd5w64NS3D+c2v96idpIhBG1OcNyOfQ0XehYweoRKyQP3kiM68+2JCg5YGY6vPMs7i97twDfeBQs1upKK9JmVCrmT3UojoNKnbVqbQSEagsxBHUlZV+Q2KCWGQ4wHOi6z3mxAI7CloiBLbCppyfF6n6BzM/UDDLl+XWlfSKlgkKZ4zXVj4jrm+zmxWOOYX9fbas30sn4vWQ8lpsrblBcTYXoVU1hcBXk82fJXJXrPoMpkJpneQc5375PmOdusSKgzgTSv7lbW2XErzSqRU4R4gYKCGucawCmvMUipP9c4YbtETOCmmVYTpv+vBlyNRvlepYYSWnTesGlbXYtSHRl3q5B+CQvePKgbncMjjtrecX7pgIkC4gTajuW0dHGtVERp8fogofVpyDRvU/M=
  skip_cleanup: true
  file_glob: true
  file: release/*
  on:
    repo: bdwyertech/aws-get-secret
    tags: true
    condition: $ARTIFACT = true
